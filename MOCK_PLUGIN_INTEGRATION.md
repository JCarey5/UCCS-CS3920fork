# Mock Plugin Integration Instructions

## Step 1: Verify Mock Plugin is Installed

Check that the mock plugin exists:
```bash
ls ../caldera/plugins/mock/
```

You should see:
- `app/` (simulation service code)
- `conf/` (agents and scenarios)
- `hook.py` (plugin entry point)

## Step 2: Copy Generated Agents File

```bash
# Backup original
cp ../caldera/plugins/mock/conf/agents.yml \
   ../caldera/plugins/mock/conf/agents.yml.backup

# Copy your generated agents
cp agents.yml ../caldera/plugins/mock/conf/agents.yml
```

## Step 3: Copy Scenario File

```bash
cp scenario_corporate.yml \
   ../caldera/plugins/mock/conf/scenarios/corporate_network.yml
```

## Step 4: Enable Mock Plugin

Edit `../caldera/conf/local.yml`:

```yaml
plugins:
  - mock
  - stockpile
  - sandcat

# Optional: Set specific agents to start
# (by default, all enabled: True agents will start)
```

## Step 5: Restart Caldera

```bash
cd ../caldera
python server.py --insecure
```

## Step 6: Verify in UI

1. Open http://localhost:8888
2. Login (default: admin/admin)
3. Go to **Agents** tab
4. You should see your simulated agents in the "simulation" group
5. They will show as green/active

## Step 7: Test with Your Attack Graph

```bash
python src/cli.py --env data/env.yaml --visualize
```

Or execute paths:
```bash
python mock_workflow.py \
  --system-config data/system_template.yaml \
  --execute 3
```

## Understanding Mock Plugin Behavior

The mock plugin:
- **Creates simulated agents** from conf/agents.yml
- **Automatically starts** agents where `enabled: True`
- **Responds to operations** with simulated results
- **Can spawn new agents** via lateral movement abilities
- **Uses scenarios** to define custom responses per ability

## Key Differences from Real Agents

| Aspect | Real Agent | Mock Agent |
|--------|-----------|------------|
| Deployment | Requires actual host | Simulated in Caldera |
| Execution | Runs actual commands | Returns mock responses |
| Lateral Movement | Must have credentials | Auto-spawns if defined |
| Detection | Real AV/EDR interaction | Simulated detection rates |
| Performance | Network dependent | Instant (in-memory) |

## Troubleshooting

### Agents Not Appearing
- Check `enabled: True` in agents.yml
- Check Caldera logs: `tail -f ../caldera/logs/caldera.log`
- Verify mock plugin loaded: Check UI plugins section

### Abilities Not Working
- Ensure stockpile plugin is enabled
- Check ability exists: Visit Abilities page in UI
- View operation results in UI for error messages

### Custom Responses Not Used
- Scenario file must be in `conf/scenarios/`
- Ability IDs must match exactly
- Operation must select the scenario (advanced ops only)

## Advanced: Custom Response Logic

The mock plugin's `simulation_svc.py` generates responses automatically.
For ability-specific responses, edit:

```python
../caldera/plugins/mock/app/simulation_svc.py
```

In the `_generate_simulated_response()` method, add your logic.

## Your Attack Graph Integration

Your CalderaClient should now work with:
```python
client = CalderaClient(
    base_url="http://localhost:8888",
    api_key="ADMIN123",
    simulation_mode=True  # This will prefer 'simulation' group
)
```

The agents will be found automatically when you call:
```python
agents = client.discover_agents(group="simulation")
```

## Next Steps

1. ✅ Verify agents appear in UI
2. ✅ Run a test operation manually in UI
3. ✅ Execute attack paths via your Python code
4. ✅ Review results and update graph probabilities
5. ✅ Iterate on your attack graph based on results

---

Generated by: convert_to_mock_plugin.py
